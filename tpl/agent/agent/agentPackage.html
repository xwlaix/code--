
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>代理商套餐</title>
    <link rel="shortcut icon" href="../../static/img/favicon.ico"/>
    <link rel="stylesheet" href="../../common/css/accordion.css">
    <link rel="stylesheet" href="../../static/css/common.css">
    <link rel="stylesheet" href="../../common/css/bootstrap.min.css">
    <link rel="stylesheet" href="../../common/js/bootstrap-table/bootstrap-table.css">
    <link rel="stylesheet" href="../../common/css/powerFloat.css">
    <link rel="stylesheet" href="../../common/css/xmenu.css">

    <script src="../../common/js/jquery-3.1.1.min.js"></script>
    <script src="../../static/js/Department.js"></script>
    <script src="../../common/js/artTemplate.js"></script>
    <script src="../../static/js/jquery-dls-xmenu.js"></script>
    <script src="../../common/js/jquery-powerFloat.js"></script>
    <script src="../../common/js/layer/layer.js"></script>
    <script src="../../common/js/bootstrap.min.js"></script>
    <script src="../../common/js/bootstrap-table/bootstrap-table.js"></script>
    <script src="../../common/js/bootstrap-table/bootstrap-table-zh-CN.js"></script>
    <script src="../../common/js/knockout/knockout.min.js"></script>
    <script src="../../common/js/knockout/knockout.mapping.js"></script>
    <script src="../../common/js/knockout/knockout.bootstraptable.js"></script>
    <script src="../../common/js/jquery.validate.js"></script>


</head>
<body>

<div class="main-box" style="width:95%">
    <div id="main-box-index">
        <div class="msgWrap form">
            <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span></button>
                            <h4 class="modal-title" id="myModalLabel">操作</h4>
                            <div class="alert">
                                <strong>提示信息!</strong>
                                <ol>
                                    <!--<li>关联关键词和外链url可选填,当您填写完外链url后关联关键词将不能生效</li>-->
                                    <!--<li>排序为数字，数字越大顺序越靠前，如果不填写将按照添加时间顺序排序</li>-->
                                </ol>
                            </div>
                        </div>
                        <form class="modal-body" id="signupForm">
                            <div class="form-group">
                                <label for="parentprice" class='price_label'>结算价:（元）</label>
                                <input type="text" name="parentprice" data-bind="value:parentprice" class="form-control"
                                       id="parentprice">
                            </div>
                            <div class="form-group">
                                <label for="price" class='price_label'>自主定价:（元）</label>
                                <input type="text" name="price" data-bind="value:price" class="form-control"
                                       id="price">
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-default btn-sm" data-dismiss="modal">
                                    <span class="glyphicon glyphicon-remove" aria-hidden="true"></span>关闭
                                </button>
                                <button type="button" id="btn_submit" class="btn btn-primary btn-sm"><span
                                        class="glyphicon glyphicon-floppy-disk" aria-hidden="true"></span>保存
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="from-groups clearfix">
        <div class="form-group">
            <label for="names">代理商名称:</label>
            <input type="text" name="names" class="form-control" id="names" value="">
        </div>
        <div class="form-group">
            <label for="sce_service_type">供应商:</label>
            <select name="service_type" id="sce_service_type" data-bind="value:service_type">
                <option class="service_type" selected="selected" value="">请选择供应商</option>

            </select>
        </div>
        <div class="form-group">
            <label for="ptype">运营商类型:</label>
            <select name="type" id="ptype" data-bind="value:type">
                <option class="type" selected="selected" value="">请选择运营商类型</option>
                <option class="type" value="1">移动</option>
                <option class="type" value="2">电信</option>
                <option class="type" value="3">联通</option>
            </select>
        </div>
        <div class="form-group ">
            <label for="pname">自定义套餐名称:</label>
            <input type="text" name="pname" class="form-control" id="pname">
            <button type="button" id="btn_sec" class="btn btn-primary btn-sm keydownBtn">搜索
            </button>
        </div>
    </div>

    <div class="modal fade" id="myselect" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                            aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title" id=" ">操作</h4>
                    <div class="alert">
                        <strong>提示信息!</strong>
                        <ol>
                            <!--<li>关联关键词和外链url可选填,当您填写完外链url后关联关键词将不能生效</li>-->
                            <!--<li>排序为数字，数字越大顺序越靠前，如果不填写将按照添加时间顺序排序</li>-->
                        </ol>
                    </div>
                    <form class="modal-body" style="margin: 0!important;padding: 0;">
                        <div class="select-package">
                            <div id="main">
                                <div id="lead" class="card">
                                    <div class="form-group" style="margin-left: 25px;">
                                        <label for="service_type">供应商:</label>
                                        <select name="service_type" id="service_type" data-bind="value:service_type">
                                            <option class="service_type" selected="selected" value="">请选择供应商</option>

                                        </select>
                                    </div>
                                    <div class="topnav">
                                        <a id="btn_cmcc" href="javascript:void(0);" class="as">
                                            <span class="btn btn-sm btn-primary">移动</span>
                                        </a>
                                        <a id="btn_ctcc" href="javascript:void(0);" class="as">
                                            <span class="btn btn-sm btn-primary">电信</span>
                                        </a>
                                        <a id="btn_cucc" href="javascript:void(0);" class="as">
                                            <span class="btn btn-sm btn-primary">联通</span>
                                        </a>
                                    </div>
                                    <div class="hidden">
                                        <label for="selectcmcc"></label>
                                        <input type="text" value="" id="selectcmcc"/>
                                    </div>
                                </div>
                            </div>

                            <div id="cmcc" class="xmenu" style="display: none; ">
                                <div class="select-info">
                                    <label class="top-label">已选套餐：</label>
                                    <ul id="cmccSelect">
                                    </ul>
                                    <a name="menu-confirm" href="javascript:">
                                        <span class="btn-package-confirm btn btn-sm btn-primary">确定</span>
                                    </a>
                                </div>
                                <dl class="choose">
                                    <dd>
                                        <ul class="center-block" id="cmccChoose">
                                        </ul>
                                    </dd>
                                </dl>
                            </div>
                            <div id="ctcc" class="xmenu" style="display: none; ">
                                <div class="select-info">
                                    <label class="top-label">已选套餐：</label>
                                    <ul id="ctccSelect">
                                    </ul>
                                    <a name="menu-confirm" href="javascript:">
                                        <span class="btn-package-confirm btn btn-sm btn-primary">确定</span>
                                    </a>
                                </div>
                                <dl class="choose">
                                    <dd>
                                        <ul class="center-block" id="ctccChoose">
                                        </ul>
                                    </dd>
                                </dl>
                            </div>

                            <div id="cucc" class="xmenu" style="display: none; ">
                                <div class="select-info">
                                    <label class="top-label">已选套餐：</label>
                                    <ul id="cuccSelect">
                                    </ul>
                                    <a name="menu-confirm" href="javascript:">
                                        <span class="btn-package-confirm btn btn-sm btn-primary">确定</span>
                                    </a>
                                </div>
                                <dl class="choose">
                                    <dd>
                                        <ul class="center-block" id="cuccChoose">
                                        </ul>
                                    </dd>
                                </dl>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <table id="tb_dept" data-bind="myBootstrapTable:$root">
    </table>

</div>
</body>
<script id="parent" type="text/html">
    {{each data as value index}}
    <option value="{{value}}">酷鱼-{{value}}
    </option>
    {{/each}}
</script>
<script id="choose" type="text/html">
    {{each list as value index}}
    <li rel="{{value.id}}" class="">
        {{value.name}}
        【酷鱼-{{value.operatorid}} ·
        {{if value.type == 1}}月包{{/if}}
        {{if value.type == 2}}季包{{/if}}
        {{if value.type == 3}}年包{{/if}}
        {{if value.type == 4}}基本套餐{{/if}}
        {{if value.type == 5}}半年包{{/if}}
        】</li>
    {{/each}}
</script>
<script id="select" type="text/html">
    <li rel="{{pid}}" class="current">{{name}}--<span class="oname">酷鱼-{{operatorid}}</span></li>
</script>
<script type="text/javascript">
    var flag = 0;

    function getOName(id) {
        $get(urlPrefix + '?r=ems/business/operator/get-all',
            function (res) {
                if (res.code == 1) {
                    parent = $(template('parent', {data: res.data}));
                    parent.appendTo(id)
                } else {
                    layer.msg(res.msg, {time: 2000})
                }
            });
    }

    getOName(service_type);
    getOName(sce_service_type);

    function select(res) {
        $(".select-info ul li").remove();
        $.each(res.data, function (i, data) {
            var parent;
            parent = $(template('select', data));
            switch (data.package_type) {
                case "1":
                    parent.appendTo('#cmccSelect');
                    break;
                case "2":
                    parent.appendTo('#ctccSelect');
                    break;
                case "3":
                    parent.appendTo('#cuccSelect');
                    break;
                default:
                    break;
            }
        });

    }

    function changeOname() {
        $("#service_type").change(function () {
            var operatorid = $("#service_type").val();
            $post(urlPrefix + "?r=ems/business/package/get-all",
                {operatorid: operatorid},
                function (res) {
                    changeName(res);
                })
        })
    }

    changeOname();


    function changeName(res) {
        $(".choose ul li").remove();
        var lib = {tab1: [], tab2: [], tab3: []};
        $.each(res.data, function (i, data) {
            switch (data.package_type) {
                case "1":
                    lib['tab1'].push(data);
                    break;
                case "2":
                    lib['tab2'].push(data);
                    break;
                case "3":
                    lib['tab3'].push(data);
                    break;
                default:
                    break;
            }
        });
        var tab1 = {list: lib.tab1};
        var tab2 = {list: lib.tab2};
        var tab3 = {list: lib.tab3};
        $("#cmccChoose").append($(template("choose", tab1)));
        $("#ctccChoose").append($(template("choose", tab2)));
        $("#cuccChoose").append($(template("choose", tab3)))
    }

    //加载table数据
    function ajaxRequest(params) {
        $post(urlPrefix + "?r=ems/agent/package-price/get-all",
            {aid: aid || "a"},
            function (res) {
                params.success({
                    data: res.data
                });
                $(".select-info ul li").remove();
                select(res);
                if (res.code == 0) {
                    layer.msg(res.msg, {time: 2000})
                }
            }, function () {
                params.success({data: []})
            }
        )
    }

    //根据url获取aid，把相应的套餐分配到对应的选项框
    var aid = getUrlParam('aid');
    var name = getUrlParam('name');
    if (name === 'null') {
        name = ''
    }
    $("#names").val(name);

    $get(urlPrefix + '?r=ems/business/package/get-all',
        function (res) {
            changeName(res)
        }, function () {
            layer.msg("获取套餐失败", {time: 2000})
        });
    function getAid(names) {
        $post(urlPrefix + "?r=ems/agent/get-one",
            {name: names},
            function (res) {
                if (res.code == 1) {
                    layer.msg('搜索成功',
                        {time: 2000});
                    aid = res.data.id;
                    getPack(aid)
                } else {
                    layer.msg('没有这个代理商',
                        {time: 2000});
                    $("#names").val(name);
                }
            }, function () {
                layer.msg("搜索失败", {time: 2000})
            }
        )
    }
    function getPack(aid){
        $post(urlPrefix + "?r=ems/agent/package-price/get-all",
            {
                aid: aid,
                name: $("#pname").val(),
                package_type: $("#ptype").val(),
                operatorid: $("#sce_service_type").val()
            },
            function (res) {
                $("#tb_dept").bootstrapTable("load",res.data);
                select(res)
            })
    }
    $(function () {
        //初始化选项框
        $("#btn_cmcc").xMenu({
            width: 800,
            eventType: "click", //事件类型 支持focus click hover
            dropmenu: "#cmcc",//弹出层
            hiddenID: "selectcmcc",//隐藏域ID
            emptytext: "移动"
        });
        $("#btn_ctcc").xMenu({
            width: 800,
            eventType: "click", //事件类型 支持focus click hover
            dropmenu: "#ctcc",//弹出层
            hiddenID: "selectcmcc",//隐藏域ID
            emptytext: "电信"
        });
        $("#btn_cucc").xMenu({
            width: 800,
            eventType: "click", //事件类型 支持focus click hover
            dropmenu: "#cucc",//弹出层
            hiddenID: "selectcmcc",//隐藏域ID
            emptytext: "联通"
        });
        //初始化分配套餐按钮
        $('.addpackage').click(function () {
            $("#myselect").modal().on("shown.bs.modal", function () {

            })
        });

        var operate = {
            //初始化按钮事件
            operateInit: function () {
                this.operateSec();
                this.DepartmentModel = {
                    price: ko.observable(),
                    id: ko.observable(),
                    parentprice: ko.observable()
                };
            },
            //搜索
            operateSec: function () {
                $('#btn_sec').on("click", function () {
                    var names = $.trim($("#names").val());
                    if (names) {
                        getAid(names)
                    } else {
                        layer.msg("请输入代理商", {time: 2000})
                    }
                });
            },
            //保存数据
            operateSave: function (index) {
                $('#btn_submit').on("click", function () {
                    //取到当前的viewmodel
                    var oViewModel = operate.DepartmentModel;
                    //将Viewmodel转换为数据model
                    var oDataModel = ko.toJS(oViewModel);
                    $post(urlPrefix + "?r=ems/agent/package-price/update",
                        {id: oDataModel.id, parentprice: oDataModel.parentprice, price: oDataModel.price},
                        function (res) {
                            if (res.code == 1) {
                                layer.msg(res.msg, {time: 2000});
                                tableInit.myViewModel.update(index, oDataModel);
                                $("#myModal").modal('hide');
                            } else {
                                layer.msg(res.msg, {time: 2000})
                            }
                        }, function () {
                            layer.msg("操作失败", {time: 2000})
                        });
                })
            }
        };


        window.operateEvents = {
            //删除
            'click #btn_delete': function (e, value, row, index) {
                layer.confirm('你确定要删除吗？', {
                    btn: ['确定', '取消']
                }, function () {
                    $post(urlPrefix + "?r=ems/agent/package-price/delete",
                        {id: row.id},
                        function (res) {
                            if (res.code == 1) {
                                layer.msg('删除成功', {time: 2000});
                                tableInit.myViewModel.remove(row.id);
                                $post(urlPrefix + "?r=ems/agent/package-price/get-all", {aid: aid},
                                    function (res) {
                                        select(res)
                                    },
                                    function () {
                                        layer.msg("操作失败", {time: 2000})
                                    });
                            } else {
                                layer.msg('删除失败', {time: 2000});
                            }
                        }, function () {
                            layer.msg("删除失败", {time: 2000})
                        });
                });
            },
            'click #jumpName': function (e, value, row, index) {
                layer.open({
                    type: 2,
                    title: '供应商套餐定价',
                    shadeClose: true,
                    shade: [0.5, 'rgb(0,0,0)'],
                    maxmin: true, //开启最大化最小化按钮
                    area: ['100%', '100%'],
                    content: "agentMorePack.html?name=" + name,
                    zIndex: layer.zIndex, //重点1
                    success: function (layero) {
                        layer.setTop(layero); //重点2
                    }
                });
            },
            //编辑
            'click #btn_edit': function (e, value, row, index) {

                $("#myModal").modal().on("shown.bs.modal", function () {

//                    ko.utils.extend(operate.DepartmentModel, oEmptyModel);
                    //将选中该行数据有数据Model通过Mapping组件转换为viewmodel
                    ko.utils.extend(operate.DepartmentModel, row);
                    ko.applyBindings(operate.DepartmentModel, document.getElementById("myModal"));
                    operate.operateSave(index);
                }).on('hidden.bs.modal', function () {
                    //关闭弹出框的时候清除绑定(这个清空包括清空绑定和清空注册事件)
                    ko.cleanNode(document.getElementById("myModal"));
                });
            }
        };

        //初始化
        $(function () {
            //1、初始化表格
            tableInit.Init();

            //2、注册增删改事件
            operate.operateInit();


        });
        //初始化表格
        var tableInit = {

            Init: function () {
                //绑定table的viewmodel
                this.myViewModel = new ko.bootstrapTableViewModel({
                    ajax: ajaxRequest,
                    toolbar: '#toolbar',                //工具按钮用哪个容器
                    queryParams: function (param) {
                        return {limit: param.limit, offset: param.offset};
                    },//传递参数（*）
                    search: true,
                    pagination: true,                   //是否显示分页（*）
                    sidePagination: "client",           //分页方式：client客户端分页，server服务端分页（*）
                    pageNumber: 1,                      //初始化加载第一页，默认第一页
                    pageSize: 10,                       //每页的记录行数（*）
                    pageList: [10, 25, 50, 100],       //可供选择的每页的行数（*）
                    onRefresh: function () {
                        $("#pname").val("");
                        $("#ptype").val("");
                        $("#sce_service_type").val("");
                    },
                    columns: [{
                        field: 'id',
                        title: 'ID'
                    }, {
                        field: 'name',
                        title: '套餐名称'
                        /* ,
                         events: operateEvents,
                         formatter: operateForName*/
                    }, {
                        field: 'oname',
                        title: '供应商',
                        formatter: operateForName
                    }, {
                        field: 'package_type',
                        title: '运营商类型',
                        formatter: operateForpackage_type
                    }, {
                        field: 'old_price',
                        title: '套餐价格:（元）'
                    }, {
                        field: 'parentprice',
                        title: '结算价:（元）'
                    }, {
                        field: 'price',
                        title: '自主定价:（元）'
                    }, {
                        field: 'addtime',
                        title: '添加时间'
                    }, {
                        field: 'operate',
                        title: '操作',
                        align: 'center',
                        events: operateEvents,
                        formatter: operateFormatter
                    }]
                });

                function operateFormatter(value, row, index) {
                    return [
                        '<button id="btn_edit" type="button" class="btn btn-sm btn-info" data-toggle="modal" data-target="#modalTable" style="margin-right:15px;>' +
                        '<span class=" " aria-hidden="true"></span>修改' +
                        '</button>'
                    ].join('');
                }

                function operateForpackage_type(value, row, index) {
                    if (row.package_type == 1) {
                        return ["移动"].join('');
                    } else if (row.package_type == 2) {
                        return ["电信"].join('');
                    } else {
                        return ["联通"].join('');
                    }
                }

                function operateForName(value, row, index) {
                    return [
                        '酷鱼-'+row.operatorid
                    ].join('');
                }


                ko.applyBindings(this.myViewModel, document.getElementById("tb_dept"));
            }


        };

        init: function n(element, valueAccessor, allBindingsAccessor, viewModel) {
            //这里的oParam就是绑定的viewmodel
            var oViewModel = valueAccessor();
            var $ele = $(element).bootstrapTable(oViewModel.params);
            //给viewmodel添加bootstrapTable方法
            oViewModel.bootstrapTable = function () {
                return $ele.bootstrapTable.apply($ele, arguments);
            }
        }


    })

</script>

</html>